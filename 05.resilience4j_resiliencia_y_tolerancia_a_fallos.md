# Sección 05: Resilience4j (Resiliencia y tolerancia a fallos)

---

## Introducción a Circuit Breaker (cortocircuito)

El patrón `Circuit Breaker` es una técnica de diseño para manejar fallos en sistemas distribuidos, como los
microservicios, y `Resilience4j` es una biblioteca que implementa este patrón en Java.

Un `Circuit Breaker` (o interruptor de circuito) es un patrón de diseño que protege un sistema de fallos repetidos. Su
funcionamiento es muy similar a un interruptor eléctrico:

1. `Cerrado (Closed)`: Cuando el sistema está funcionando correctamente, el interruptor está cerrado y las solicitudes
   pasan normalmente.

2. `Abierto (Open)`: Si se detectan fallos repetidos (por ejemplo, un servicio no responde), el interruptor se abre y
   las solicitudes no se envían al servicio. En su lugar, el sistema puede devolver una respuesta predeterminada o
   realizar una acción alternativa.

3. `Semi-abierto (Half-Open)`: Después de un periodo de tiempo, el `Circuit Breaker` permite algunas solicitudes de
   prueba (de forma controlada) para ver si el servicio ha recuperado su estabilidad. Si estas solicitudes tienen éxito,
   el circuito se cierra completamente; si fallan, el circuito se abre de nuevo.

![01.png](assets/section-05/01.png)

## Resilience4j

`Resilience4j` es una librería ligera que permite implementar este patrón en Java, y tiene muchas características
útiles como:

- `Circuit Breaker`: Maneja fallos de servicios externos.
- `Rate Limiter`: Limita la cantidad de solicitudes por unidad de tiempo.
- `Retry`: Vuelve a intentar operaciones fallidas.
- `Bulkhead`: Limita el daño de fallos a una parte del sistema.
- `TimeLimiter`: Limita el tiempo de ejecución de operaciones asíncronas.

## Parámetros del Circuit Breaker

- `slidingWindowSize (100)`, el tamaño de la ventana deslizante es por defecto de 100 peticiones. Es decir, se va a
  trabajar con base en 100 solicitudes para determinar la taza de fallos y éxitos.
- `failureRateThreshold(50)`, representa el porcentaje de falla, es el umbral de fallos que por defecto es del `50%`. Es
  decir, si de los 100 request (`slidingWindowSize`) fallan el 50%, entonces se abre el cortocircuito `OPEN`. Después de
  60 segundos (por defecto) pasa al estado semiabierto `HALF_OPEN`. Estando en estado semiabierto realiza peticiones de
  prueba para verificar si el servicio sigue fallando o ya no, de esa forma ver si se regresa a `OPEN` o pasa a
  `CLOSED`.
- `waitDurationInOpenState (60000ms)`, tiempo de duración en el que permanece en estado `OPEN`, por defecto es de 60
  segundos (60000ms).
- `permittedNumberOfCallsInHalfOpenState(10)`, número permitido de llamadas en estado `HALF_OPEN`, por defecto, son 10.
  Ahora, si el porcentaje de fallas en este estado `HALF_OPEN` supera el 50% (`failureRateThreshold`) entonces seguimos
  en estado `OPEN`, pero si las fallas son menores al 50%, entonces se consiera que es momento de regresar al estado
  `CLOSED`. Por ejemplo, si de las 10 llamadas, 2 son de fallo y 8 son de éxito, entonces se pasa al estado `CLOSED`, ya
  que es mayor al 50% la tasa de éxito.
- `slowCallRateThreshold(100)`, umbral cuando la llamada es lenta.
- `slowCallDurationThreshold(60000ms)`, se considera que una llamada es lenta si tiene esta duración de 60000ms.
