# Secci贸n 11: Trazabilidad distribuida con Micrometer Tracing y Zipkin

---

## Introducci贸n a la trazabilidad distribuida

### 驴Qu茅 es Micrometer?

`Micrometer` es una `facade (fachada) para m茅tricas` en aplicaciones Java. Es la biblioteca de m茅tricas integrada por
defecto en `Spring Boot 2+`, y permite recolectar y exportar m茅tricas hacia distintos sistemas como `Prometheus`,
`Datadog`, `New Relic`, entre otros.

Desde `Spring Boot 3`, `Micrometer` tambi茅n incluye soporte para trazabilidad distribuida a trav茅s de su m贸dulo llamado
`Micrometer Tracing`, que reemplaza al antiguo `spring-cloud-sleuth`.

### Funciones clave de Micrometer Tracing:

- Generaci贸n autom谩tica de `trazas (traces)` y `spans` para cada solicitud entrante y saliente.
- `Propagaci贸n de contexto` entre microservicios, incluso cuando se usan tecnolog铆as reactivas como `WebFlux`.
- Soporte para `exportaci贸n de trazas` hacia sistemas como `Zipkin` o `OpenTelemetry`.
- Integraci贸n fluida con `Spring Cloud Gateway`, `RestTemplate`, `WebClient`, `Feign`, etc.

### 驴Qu茅 es Zipkin?

`Zipkin` es una herramienta de trazabilidad distribuida desarrollada por Twitter. Su prop贸sito es recoger, almacenar y
visualizar trazas de solicitudes que fluyen entre los diferentes servicios de una arquitectura distribuida (como los
microservicios).

### Funcionalidades principales:

- Visualizaci贸n de `todo el recorrido de una solicitud` a trav茅s de m煤ltiples microservicios.
- An谩lisis de `latencia`, cuellos de botella, y puntos de fallo.
- Muestra de cada `span` (segmento de una operaci贸n) con detalles como duraci贸n, nombre del servicio, etiquetas
  personalizadas, etc.

### 驴C贸mo se conecta con Micrometer?

`Micrometer Tracing` puede usar un reporter para enviar las trazas recolectadas a `Zipkin`. As铆, `Zipkin` se convierte
en el backend de visualizaci贸n de las trazas generadas por tu aplicaci贸n.

### Relaci贸n entre Micrometer y Zipkin

| Componente           | Rol                                       |
|----------------------|-------------------------------------------|
| `Micrometer Tracing` | Genera y gestiona trazas/spans en la app. |
| `Zipkin`             | Recibe, almacena y visualiza las trazas.  |

### 驴Qu茅 son el `traceId` y el `spanId`?

En un sistema de `trazabilidad distribuida`, como el que se implementa con `Micrometer Tracing` y `Zipkin`, se utiliza
una estructura jer谩rquica para rastrear c贸mo una solicitud fluye a trav茅s de varios servicios.

1.  `traceId` (ID de traza)

- Es un `identificador 煤nico` que representa una `煤nica solicitud de extremo a extremo` a trav茅s de todo el sistema
  distribuido.
- Todos los `spans` (segmentos) relacionados con esa solicitud comparten el mismo `traceId`.
- Permite reconstruir toda la cadena de eventos y llamadas que ocurrieron desde el inicio hasta el final de la petici贸n.

  >  `Ejemplo`: Una solicitud HTTP que entra por el `gateway-server` y luego pasa a `item-service` y despu茅s a
  > `product-service`, tendr谩 el mismo `traceId` en todos esos servicios.

2.  `spanId` (ID de segmento)

- Es un `identificador 煤nico` para una `operaci贸n individual dentro del sistema`.
- Cada vez que un servicio realiza una operaci贸n (como llamar a otro servicio, acceder a una base de datos, etc.), se
  crea un nuevo `span` con su propio `spanId`.
- Un `span` puede tener un `parentSpanId`, que indica qui茅n lo invoc贸.

  >  `Ejemplo`: El `gateway-server` recibe una solicitud y genera un `spanId`. Luego, cuando llama al `item-service`,
  > se genera otro `spanId` con el `spanId` del `gateway` como padre.

Imaginemos la siguiente estructura de llamada:

````
traceId: abc123
 spanId: 001 (Gateway)
     spanId: 002 (Llamada a item-service)
     spanId: 003 (Llamada a product-service)
````

- Todos los `spanId` est谩n relacionados al mismo `traceId` porque son parte de la misma solicitud.
- Pero cada operaci贸n tiene su propio `spanId`, lo que permite saber qu茅 parte de la solicitud tom贸 cu谩nto tiempo y
  d贸nde se ejecut贸.
