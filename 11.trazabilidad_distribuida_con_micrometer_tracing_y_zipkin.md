# SecciÃ³n 11: Trazabilidad distribuida con Micrometer Tracing y Zipkin

---

## IntroducciÃ³n a la trazabilidad distribuida

En 2016, el equipo de `Spring Cloud` creÃ³ una biblioteca de rastreo que podrÃ­a ser de gran ayuda para muchos
desarrolladores. Se llamÃ³ `Spring Cloud Sleuth`. El equipo de `Spring` se dio cuenta de que el rastreo podÃ­a
separarse de `Spring Cloud` y creÃ³ el proyecto `Micrometer Tracing`, que es, esencialmente, una copia de
`Spring Cloud Sleuth` independiente de `Spring`. `Micrometer Tracing` se lanzÃ³ con su versiÃ³n 1.0.0 GA en
noviembre de 2022 y ha mejorado constantemente desde entonces.

### Â¿QuÃ© es Micrometer?

`Micrometer` es una `facade (fachada) para mÃ©tricas` en aplicaciones Java. Es la biblioteca de mÃ©tricas integrada por
defecto en `Spring Boot 2+`, y permite recolectar y exportar mÃ©tricas hacia distintos sistemas como `Prometheus`,
`Datadog`, `New Relic`, entre otros.

Desde `Spring Boot 3`, `Micrometer` tambiÃ©n incluye soporte para trazabilidad distribuida a travÃ©s de su mÃ³dulo llamado
`Micrometer Tracing`, que reemplaza al antiguo `spring-cloud-sleuth`.

### Funciones clave de Micrometer Tracing:

- GeneraciÃ³n automÃ¡tica de `trazas (traces)` y `spans` para cada solicitud entrante y saliente.
- `PropagaciÃ³n de contexto` entre microservicios, incluso cuando se usan tecnologÃ­as reactivas como `WebFlux`.
- Soporte para `exportaciÃ³n de trazas` hacia sistemas como `Zipkin` o `OpenTelemetry`.
- IntegraciÃ³n fluida con `Spring Cloud Gateway`, `RestTemplate`, `WebClient`, `Feign`, etc.

### Â¿QuÃ© es Zipkin?

`Zipkin` es una herramienta de trazabilidad distribuida desarrollada por Twitter. Su propÃ³sito es recoger, almacenar y
visualizar trazas de solicitudes que fluyen entre los diferentes servicios de una arquitectura distribuida (como los
microservicios).

### Funcionalidades principales:

- VisualizaciÃ³n de `todo el recorrido de una solicitud` a travÃ©s de mÃºltiples microservicios.
- AnÃ¡lisis de `latencia`, cuellos de botella, y puntos de fallo.
- Muestra de cada `span` (segmento de una operaciÃ³n) con detalles como duraciÃ³n, nombre del servicio, etiquetas
  personalizadas, etc.

### Â¿CÃ³mo se conecta con Micrometer?

`Micrometer Tracing` puede usar un reporter para enviar las trazas recolectadas a `Zipkin`. AsÃ­, `Zipkin` se convierte
en el backend de visualizaciÃ³n de las trazas generadas por tu aplicaciÃ³n.

### RelaciÃ³n entre Micrometer y Zipkin

| Componente           | Rol                                       |
|----------------------|-------------------------------------------|
| `Micrometer Tracing` | Genera y gestiona trazas/spans en la app. |
| `Zipkin`             | Recibe, almacena y visualiza las trazas.  |

### Â¿QuÃ© son el `traceId` y el `spanId`?

En un sistema de `trazabilidad distribuida`, como el que se implementa con `Micrometer Tracing` y `Zipkin`, se utiliza
una estructura jerÃ¡rquica para rastrear cÃ³mo una solicitud fluye a travÃ©s de varios servicios.

1. ðŸ“ `traceId` (ID de traza)

- Es un `identificador Ãºnico` que representa una `Ãºnica solicitud de extremo a extremo` a travÃ©s de todo el sistema
  distribuido.
- Todos los `spans` (segmentos) relacionados con esa solicitud comparten el mismo `traceId`.
- Permite reconstruir toda la cadena de eventos y llamadas que ocurrieron desde el inicio hasta el final de la peticiÃ³n.

  > ðŸ§  `Ejemplo`: Una solicitud HTTP que entra por el `gateway-server` y luego pasa a `item-service` y despuÃ©s a
  > `product-service`, tendrÃ¡ el mismo `traceId` en todos esos servicios.

2. ðŸ“ `spanId` (ID de segmento)

- Es un `identificador Ãºnico` para una `operaciÃ³n individual dentro del sistema`.
- Cada vez que un servicio realiza una operaciÃ³n (como llamar a otro servicio, acceder a una base de datos, etc.), se
  crea un nuevo `span` con su propio `spanId`.
- Un `span` puede tener un `parentSpanId`, que indica quiÃ©n lo invocÃ³.

  > ðŸ§  `Ejemplo`: El `gateway-server` recibe una solicitud y genera un `spanId`. Luego, cuando llama al `item-service`,
  > se genera otro `spanId` con el `spanId` del `gateway` como padre.

Imaginemos la siguiente estructura de llamada:

````
traceId: abc123
â””â”€â”€ spanId: 001 (Gateway)
    â”œâ”€â”€ spanId: 002 (Llamada a item-service)
    â””â”€â”€ spanId: 003 (Llamada a product-service)
````

- Todos los `spanId` estÃ¡n relacionados al mismo `traceId` porque son parte de la misma solicitud.
- Pero cada operaciÃ³n tiene su propio `spanId`, lo que permite saber quÃ© parte de la solicitud tomÃ³ cuÃ¡nto tiempo y
  dÃ³nde se ejecutÃ³.

## Agregando Dependencia de Micrometer Tracing

En este apartado nos guiaremos de la
[documentaciÃ³n oficial de Micrometer Tracing](https://docs.micrometer.io/tracing/reference/tracers.html) para obtener
la dependencia que agregaremos a nuestros proyectos.

Agregamos las siguientes dependencias en el `pom.xml` de los siguientes microservicios:

- item-service
- product-service
- user-service
- gateway-server
- authorization-server

````xml

<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-actuator</artifactId>
    </dependency>
    <dependency>
        <groupId>io.micrometer</groupId>
        <artifactId>micrometer-tracing-bridge-brave</artifactId>
    </dependency>
</dependencies>
````

**Nota**
> La dependencia `micrometer-tracing-bridge-brave` incluye transitivamente la dependencia `micrometer-tracing`, por lo
> que `no es necesario declararla por separado`.
>
> Se utiliza la dependencia `spring-boot-starter-actuator` para habilitar los endpoints de `observabilidad` y `salud`
> del sistema.

### 1. âœ… micrometer-tracing

- Esta es la `API base de trazabilidad distribuida` proporcionada por `Micrometer`.
- Define las interfaces genÃ©ricas como `Tracer`, `Span`, `ContextPropagator`, etc.
- No contiene implementaciÃ³n especÃ­fica: `no genera ni reporta trazas por sÃ­ sola`.
- Es Ãºtil si estÃ¡s creando algo muy personalizado o si estÃ¡s haciendo una librerÃ­a que no debe acoplarse a una
  implementaciÃ³n en particular (como `Brave` u `OpenTelemetry`).

### 2. âœ… micrometer-tracing-bridge-brave

- Esta es la `implementaciÃ³n que conecta Micrometer con Brave`, el motor de trazabilidad desarrollado originalmente por
  Twitter (y usado por Zipkin).
- Al incluir esta dependencia:
    - Se implementan las interfaces de `micrometer-tracing`.
    - Se integra automÃ¡ticamente con `Spring Boot`.
    - Se activa el trazado y la `propagaciÃ³n de contexto` con `Brave`.

## Configurando trazabilidad

Agregamos las siguientes configuraciones en el `application.yml` de los siguientes microservicios:

- item-service
- product-service
- user-service
- gateway-server
- authorization-server

````yml
management:
  tracing:
    sampling:
      probability: 1.0
````

La configuraciÃ³n anterior define `cuÃ¡ntas trazas se van a capturar` en tu aplicaciÃ³n.

- Es una probabilidad de muestreo entre `0.0` y `1.0`.
- `1.0` â†’ se capturan todas las trazas (100% de las solicitudes).
- `0.5` â†’ se capturan el `50%` de las solicitudes de forma aleatoria.
- `0.0` â†’ no se captura ninguna traza.

> âœ… Esto es `muy Ãºtil en desarrollo`, porque te permite ver todo el flujo de las peticiones entre microservicios.<br>
> âš ï¸ En producciÃ³n, a veces se recomienda bajar esta probabilidad (por ejemplo, a 0.1) para no sobrecargar tu sistema
> de observabilidad.
