# Secci√≥n 11: Trazabilidad distribuida con Micrometer Tracing y Zipkin

---

## Introducci√≥n a la trazabilidad distribuida

En 2016, el equipo de `Spring Cloud` cre√≥ una biblioteca de rastreo que podr√≠a ser de gran ayuda para muchos
desarrolladores. Se llam√≥ `Spring Cloud Sleuth`. El equipo de `Spring` se dio cuenta de que el rastreo pod√≠a
separarse de `Spring Cloud` y cre√≥ el proyecto `Micrometer Tracing`, que es, esencialmente, una copia de
`Spring Cloud Sleuth` independiente de `Spring`. `Micrometer Tracing` se lanz√≥ con su versi√≥n 1.0.0 GA en
noviembre de 2022 y ha mejorado constantemente desde entonces.

### ¬øQu√© es Micrometer?

`Micrometer` es una `facade (fachada) para m√©tricas` en aplicaciones Java. Es la biblioteca de m√©tricas integrada por
defecto en `Spring Boot 2+`, y permite recolectar y exportar m√©tricas hacia distintos sistemas como `Prometheus`,
`Datadog`, `New Relic`, entre otros.

Desde `Spring Boot 3`, `Micrometer` tambi√©n incluye soporte para trazabilidad distribuida a trav√©s de su m√≥dulo llamado
`Micrometer Tracing`, que reemplaza al antiguo `spring-cloud-sleuth`.

### Funciones clave de Micrometer Tracing:

- Generaci√≥n autom√°tica de `trazas (traces)` y `spans` para cada solicitud entrante y saliente.
- `Propagaci√≥n de contexto` entre microservicios, incluso cuando se usan tecnolog√≠as reactivas como `WebFlux`.
- Soporte para `exportaci√≥n de trazas` hacia sistemas como `Zipkin` o `OpenTelemetry`.
- Integraci√≥n fluida con `Spring Cloud Gateway`, `RestTemplate`, `WebClient`, `Feign`, etc.

### ¬øQu√© es Zipkin?

`Zipkin` es una herramienta de trazabilidad distribuida desarrollada por Twitter. Su prop√≥sito es recoger, almacenar y
visualizar trazas de solicitudes que fluyen entre los diferentes servicios de una arquitectura distribuida (como los
microservicios).

### Funcionalidades principales:

- Visualizaci√≥n de `todo el recorrido de una solicitud` a trav√©s de m√∫ltiples microservicios.
- An√°lisis de `latencia`, cuellos de botella, y puntos de fallo.
- Muestra de cada `span` (segmento de una operaci√≥n) con detalles como duraci√≥n, nombre del servicio, etiquetas
  personalizadas, etc.

### ¬øC√≥mo se conecta con Micrometer?

`Micrometer Tracing` puede usar un reporter para enviar las trazas recolectadas a `Zipkin`. As√≠, `Zipkin` se convierte
en el backend de visualizaci√≥n de las trazas generadas por tu aplicaci√≥n.

### Relaci√≥n entre Micrometer y Zipkin

| Componente           | Rol                                       |
|----------------------|-------------------------------------------|
| `Micrometer Tracing` | Genera y gestiona trazas/spans en la app. |
| `Zipkin`             | Recibe, almacena y visualiza las trazas.  |

### ¬øQu√© son el `traceId` y el `spanId`?

En un sistema de `trazabilidad distribuida`, como el que se implementa con `Micrometer Tracing` y `Zipkin`, se utiliza
una estructura jer√°rquica para rastrear c√≥mo una solicitud fluye a trav√©s de varios servicios.

1. üìç `traceId` (ID de traza)

- Es un `identificador √∫nico` que representa una `√∫nica solicitud de extremo a extremo` a trav√©s de todo el sistema
  distribuido.
- Todos los `spans` (segmentos) relacionados con esa solicitud comparten el mismo `traceId`.
- Permite reconstruir toda la cadena de eventos y llamadas que ocurrieron desde el inicio hasta el final de la petici√≥n.

  > üß† `Ejemplo`: Una solicitud HTTP que entra por el `gateway-server` y luego pasa a `item-service` y despu√©s a
  > `product-service`, tendr√° el mismo `traceId` en todos esos servicios.

2. üìç `spanId` (ID de segmento)

- Es un `identificador √∫nico` para una `operaci√≥n individual dentro del sistema`.
- Cada vez que un servicio realiza una operaci√≥n (como llamar a otro servicio, acceder a una base de datos, etc.), se
  crea un nuevo `span` con su propio `spanId`.
- Un `span` puede tener un `parentSpanId`, que indica qui√©n lo invoc√≥.

  > üß† `Ejemplo`: El `gateway-server` recibe una solicitud y genera un `spanId`. Luego, cuando llama al `item-service`,
  > se genera otro `spanId` con el `spanId` del `gateway` como padre.

Imaginemos la siguiente estructura de llamada:

````
traceId: abc123
‚îî‚îÄ‚îÄ spanId: 001 (Gateway)
    ‚îú‚îÄ‚îÄ spanId: 002 (Llamada a item-service)
    ‚îî‚îÄ‚îÄ spanId: 003 (Llamada a product-service)
````

- Todos los `spanId` est√°n relacionados al mismo `traceId` porque son parte de la misma solicitud.
- Pero cada operaci√≥n tiene su propio `spanId`, lo que permite saber qu√© parte de la solicitud tom√≥ cu√°nto tiempo y
  d√≥nde se ejecut√≥.

## Agregando Dependencia de Micrometer Tracing

En este apartado nos guiaremos de la
[documentaci√≥n oficial de Micrometer Tracing](https://docs.micrometer.io/tracing/reference/tracers.html) para obtener
la dependencia que agregaremos a nuestros proyectos.

Agregamos las siguientes dependencias en el `pom.xml` de los siguientes microservicios:

- item-service
- product-service
- user-service
- gateway-server
- authorization-server

````xml

<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-actuator</artifactId>
    </dependency>
    <dependency>
        <groupId>io.micrometer</groupId>
        <artifactId>micrometer-tracing-bridge-brave</artifactId>
    </dependency>
</dependencies>
````

**Nota**
> La dependencia `micrometer-tracing-bridge-brave` incluye transitivamente la dependencia `micrometer-tracing`, por lo
> que `no es necesario declararla por separado`.
>
> Se utiliza la dependencia `spring-boot-starter-actuator` para habilitar los endpoints de `observabilidad` y `salud`
> del sistema.

### 1. ‚úÖ micrometer-tracing

- Esta es la `API base de trazabilidad distribuida` proporcionada por `Micrometer`.
- Define las interfaces gen√©ricas como `Tracer`, `Span`, `ContextPropagator`, etc.
- No contiene implementaci√≥n espec√≠fica: `no genera ni reporta trazas por s√≠ sola`.
- Es √∫til si est√°s creando algo muy personalizado o si est√°s haciendo una librer√≠a que no debe acoplarse a una
  implementaci√≥n en particular (como `Brave` u `OpenTelemetry`).

### 2. ‚úÖ micrometer-tracing-bridge-brave

- Esta es la `implementaci√≥n que conecta Micrometer con Brave`, el motor de trazabilidad desarrollado originalmente por
  Twitter (y usado por Zipkin).
- Al incluir esta dependencia:
    - Se implementan las interfaces de `micrometer-tracing`.
    - Se integra autom√°ticamente con `Spring Boot`.
    - Se activa el trazado y la `propagaci√≥n de contexto` con `Brave`.

